// ////////////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////////////
// MLB MFStore Library Module File
// ////////////////////////////////////////////////////////////////////////////
/*
   File Name         :  MFStoreControl.cpp

   File Description  :  Implementation of the MFStoreControl class.

   Revision History  :  2021-02-14 --- Creation.
                           Michael L. Brock

      Copyright Michael L. Brock 2021 - 2024.
      Distributed under the Boost Software License, Version 1.0.
      (See accompanying file LICENSE_1_0.txt or copy at
      http://www.boost.org/LICENSE_1_0.txt)

*/
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////////////
// Required include files...
// ////////////////////////////////////////////////////////////////////////////

#include <MFStore/MFStoreControl.hpp>

#include <MFStore/CheckValues.hpp>

#include <Utility/ArgCheck.hpp>

// ////////////////////////////////////////////////////////////////////////////

namespace MLB {

namespace MFStore {

// ////////////////////////////////////////////////////////////////////////////
MFStoreControl::MFStoreControl()
	:mapping_sptr_()
	,region_sptr_()
	,file_name_()
	,file_size_(0)
	,mmap_size_(0)
	,alloc_gran_(0)
{
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MFStoreControl::MFStoreControl(const std::string &file_name, bool is_writer,
	MFStoreLen file_size, MFStoreLen mmap_size, MFStoreLen alloc_gran,
	const MFStoreSectionList &section_list)
try
	:mapping_sptr_()
	,region_sptr_()
	,file_name_()
	,file_size_(0)
	,mmap_size_(0)
	,alloc_gran_(0)
	,section_list_(section_list)
{
	using namespace boost::interprocess;

	MLB::Utility::ThrowIfEmpty(file_name, "The MFStore file name");

	CheckInitialFileAndMmapSizes(file_size, mmap_size, alloc_gran);

	FileMappingSPtr  mapping_sptr(
		std::make_shared<FileMapping>(file_name.c_str(),
			(is_writer) ? read_write : read_only));
	MappedRegionSPtr region_sptr(
		std::make_shared<MappedRegion>(*mapping_sptr,
			(is_writer) ? read_write : read_only, 0, mmap_size));

	mapping_sptr_.swap(mapping_sptr);
	region_sptr_.swap(region_sptr);

	file_name_  = file_name;
	file_size_  = file_size;
	mmap_size_  = mmap_size;
	alloc_gran_ = alloc_gran;
}
catch (const std::exception &except) {
	std::runtime_error("Failed to create interprocess mapping and region for "
		"'" + file_name + "' with a size of " + std::to_string(file_size) +
		"bytes and a mmap size of " + std::to_string(mmap_size) + " bytes: " +
		std::string(except.what()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool MFStoreControl::IsActive() const
{
	return(mapping_sptr_.get() && region_sptr_.get());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool MFStoreControl::CheckIsActive(bool throw_on_error) const
{
	if (IsActive())
		return(true);
	else if (throw_on_error)
		throw std::runtime_error("The MFStoreControl instance does not contain "
			"an active file mapping.");

	return(false);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool MFStoreControl::IsWriter() const
{
	return(IsActive() &&
		(mapping_sptr_->get_mode() == boost::interprocess::read_write));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool MFStoreControl::CheckIsWriter(bool throw_on_error) const
{
	if (IsWriter())
		return(true);
	else if (throw_on_error)
		throw std::runtime_error("The MFStoreControl instance is not open "
			"for writing.");

	return(false);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const std::string &MFStoreControl::GetFileName() const
{
	return(file_name_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MFStoreFileHandle MFStoreControl::GetFileHandle() const
{
	CheckIsActive();

	return(mapping_sptr_->get_mapping_handle().handle);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MFStoreLen MFStoreControl::GetFileSize() const
{
	return(file_size_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MFStoreLen MFStoreControl::GetMmapSize() const
{
	return(mmap_size_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MFStoreLen MFStoreControl::GetAllocGran() const
{
	return(alloc_gran_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void *MFStoreControl::GetMmapAddress() const
{
	CheckIsActive();

	return(region_sptr_->get_address());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
FileMappingSPtr MFStoreControl::GetMappingSPtr() const
{
	return(mapping_sptr_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
MappedRegionSPtr MFStoreControl::GetRegionSPtr() const
{
	return(region_sptr_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const MFStoreSectionList &MFStoreControl::GetSectionList() const
{
	return(section_list_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void MFStoreControl::SetSectionList(const MFStoreSectionList &src)
{
	section_list_ = src;
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void MFStoreControl::CheckSectionList() const
{
	CheckSectionList(section_list_);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void MFStoreControl::CheckSectionList(const MFStoreSectionList &section_list)
	const
{
	CheckIsActive(true);

	MFStoreSection::CheckSectionList(section_list, alloc_gran_, file_size_);
}
// ////////////////////////////////////////////////////////////////////////////

} // namespace MFStore

} // namespace MLB

